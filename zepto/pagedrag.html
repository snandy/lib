<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta content="email=no" name="format-detection">
    <title>pagedrag</title>
    <link rel="stylesheet" href="skin/pagedrag.css"/>
</head> 
<body> 
<div class="wrapper" id="wrap">
    <!-- PAGE 1 -->
    <section class="page page_1">
        <p>page1</p>
    </section>
    <!-- PAGE 2 -->
    <section class="page page_1">
        <p>page2</p>
    </section>
    <!-- PAGE 3 -->
    <section class="page page_1">
        <p>page3</p>
    </section>
    <!-- PAGE 4 -->
    <section class="page page_1">
        <p>page4</p>
    </section>
    <!-- PAGE 5 -->
    <section class="page page_1">
        <p>page5</p>
    </section>
    <!-- PAGE 6 -->
    <section class="page page_1">
        <p>page6</p>
    </section>
</div>
<script src="mo.js"></script>
<script src="zepto.js"></script>
<script>
$.fn.pagedrag = function(option, callback) {
    var setting = $.extend({
        direction: 'Y'
    }, option);

    var prefix = mo.prefix;
    var transform = prefix + 'transform';
    var docElem = document.documentElement;


    function getTranslate3D(elem) {
        var result = {x: 0, y: 0, z: 0};
        var trans  = elem.style[transform];

        //没有值，直接中断
        if (!trans || trans == 'none') return result;

        var reg = RegExp('translate3d\\(([^\\)]+)\\)','ig');
        var res = trans.match(reg);
        if (res && res.length) {
            var arr = res[0].replace(reg, '$1').split(',');
            result.x = parseInt(arr[0], 10);
            result.y = parseInt(arr[1], 10);
            result.z = parseInt(arr[2], 10);
        }

        return result;
    }
    function bootstrap($elem) {
        var direction = setting.direction;
        var elem = $elem[0];
        var sw = elem.scrollWidth;
        var sh = elem.scrollHeight;
        var cw = docElem.clientWidth;
        var ch = docElem.clientHeight;
        window.addEventListener('resize', function() {
            ch = docElem.clientHeight;
            cw = docElem.clientWidth;
        }, false);

        var total = 'X' == direction ? (Math.ceil(sw/cw)) : (Math.ceil(sh/ch));
        var cur = 0;
        var previous = -1;
        var next = 1; 
        var startX = 0
        var startY = 0;
        var x = 0;
        var y = 0;
        var offset = 0;
        var motion = 'none'
        var lock = false;

        function fixPage(num) {
            if (!total) return num;
            //使页码正确
            if(num >= 0) {
                return num%total;
            } else {
                return (total + num % total);
            }
        }

        $elem.on('touchstart', function(ev) {
            var toucher = ev.targetTouches || ev.changedTouches;
            var touchObj = toucher[0];
            var trans3d = getTranslate3D(elem);
            startX = touchObj.pageX;
            startY = touchObj.pageY;
            console.log(startY)
            x = trans3d.x;
            y = trans3d.y;
            console.log(y)
            // // 需要重新取值
            // if (!sw && !sh) {
            //     sh = elem.scrollHeight;
            //     sw = elem.scrollWidth;
            //     total = 'X' == direction ? (Math.ceil(sw/cw)) : (Math.ceil(sh/ch));
            //     next = fixPage(cur + 1);
            //     previous = fixPage(cur - 1);
            // }
            // motion = 'none';         
        });
        $elem.on('touchmove', function(ev) {
            var toucher = ev.targetTouches || ev.changedTouches;
            var touchObj = toucher[0];
            var pageX = touchObj.pageX;
            var pageY = touchObj.pageY;
            var offset = pageY - startY;
            // console.log(offset)
            $elem.css(transform, 'translate3d(0,' + (y+offset) + 'px,0)')
        });

    }

    // 实例化每个对象
    return this.each(function() {
        var $elem = $(this)
        bootstrap($elem)
        if ($.isFunction(callback)) callback($elem)
    })
};

$('#wrap').pagedrag();
</script>
</body>
</html>